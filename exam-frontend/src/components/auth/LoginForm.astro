---
// src/components/auth/LoginForm.astro
---

<div class="card w-full max-w-md bg-base-100 shadow-xl">
  <div class="card-body">
    <h2 class="card-title mb-4 text-center text-2xl font-bold">Login Sistem Ujian</h2>

    <div id="error-alert" class="alert alert-error mb-4 hidden">
      <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <span id="error-message"></span>
    </div>

    <form id="login-form" class="space-y-4">
      <div class="form-control">
        <label class="label">
          <span class="label-text">Username</span>
        </label>
        <input
          type="text"
          name="username"
          placeholder="Masukkan username"
          class="input input-bordered w-full"
          required
          autocomplete="username"
        />
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text">Password</span>
        </label>
        <input
          type="password"
          name="password"
          placeholder="Masukkan password"
          class="input input-bordered w-full"
          required
          autocomplete="current-password"
        />
      </div>

      <div class="form-control mt-6">
        <button type="submit" class="btn btn-primary w-full" id="login-btn">
          <span id="login-text">Login</span>
          <span id="login-loading" class="loading loading-spinner loading-sm hidden"></span>
        </button>
      </div>
    </form>

    <div class="mt-4 text-center">
      <p class="text-sm text-base-content/70">
        Pastikan koneksi internet stabil untuk login pertama kali
      </p>
    </div>
  </div>
</div>

<script>
  import { login } from '@/lib/api/auth';
  import { showToast } from '@/stores/toast';

  const form = document.getElementById('login-form') as HTMLFormElement;
  const errorAlert = document.getElementById('error-alert');
  const errorMessage = document.getElementById('error-message');
  const loginText = document.getElementById('login-text');
  const loginLoading = document.getElementById('login-loading');
  const loginBtn = document.getElementById('login-btn') as HTMLButtonElement;

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    errorAlert?.classList.add('hidden');
    loginBtn.disabled = true;
    loginText?.classList.add('hidden');
    loginLoading?.classList.remove('hidden');

    const formData = new FormData(form);
    const credentials = {
      username: formData.get('username') as string,
      password: formData.get('password') as string,
    };

    try {
      const response = await login(credentials);

      const role = response.user.role;
      const redirectMap: Record<string, string> = {
        siswa: '/siswa/dashboard',
        guru: '/guru/dashboard',
        pengawas: '/pengawas/dashboard',
        operator: '/operator/dashboard',
        superadmin: '/superadmin/dashboard',
      };

      window.location.href = redirectMap[role] || '/';
    } catch (error: any) {
      if (errorMessage && errorAlert) {
        errorMessage.textContent =
          error.response?.data?.error || 'Login gagal. Periksa username dan password Anda.';
        errorAlert.classList.remove('hidden');
      }

      loginBtn.disabled = false;
      loginText?.classList.remove('hidden');
      loginLoading?.classList.add('hidden');
    }
  });
</script>
