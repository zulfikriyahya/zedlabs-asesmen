---
interface Props {
  surah: string;
  ayahStart: number;
  ayahEnd: number;
  maxDuration?: number; // detik
}

const { surah, ayahStart, ayahEnd, maxDuration = 300 } = Astro.props;
---

<div class="card bg-base-100 border border-base-200 shadow-sm">
  <div class="card-body p-4">
    <h3 class="font-bold text-center mb-2">Rekaman Hafalan</h3>
    <p class="text-xs text-center text-base-content/70 mb-4">
      QS. {surah}: {ayahStart}-{ayahEnd} (Maks. {maxDuration / 60} menit)
    </p>

    <!-- Visualizer Area -->
    <div class="bg-base-300 rounded-lg h-24 flex items-center justify-center mb-4 relative overflow-hidden">
      <div id="waveform" class="flex items-end gap-[2px] h-16 w-full px-4 justify-center opacity-50">
        <!-- Bars generated by JS -->
      </div>
      <div id="timer-display" class="absolute inset-0 flex items-center justify-center font-mono text-2xl font-bold z-10">
        00:00
      </div>
    </div>

    <!-- Controls -->
    <div class="flex justify-center gap-4">
      <button id="record-btn" class="btn btn-circle btn-error btn-lg shadow-lg border-4 border-base-100">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd" />
        </svg>
      </button>

      <button id="stop-btn" class="btn btn-circle btn-neutral btn-lg hidden">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd" />
        </svg>
      </button>
    </div>

    <!-- Playback Preview (Hidden initially) -->
    <div id="preview-container" class="hidden mt-4">
      <audio id="audio-preview" controls class="w-full mb-2"></audio>
      <div class="flex justify-end gap-2">
        <button id="retry-btn" class="btn btn-ghost btn-sm">Rekam Ulang</button>
        <button id="save-btn" class="btn btn-primary btn-sm">Simpan</button>
      </div>
    </div>
  </div>
</div>

<script define:vars={{ maxDuration }}>
  let mediaRecorder;
  let audioChunks = [];
  let startTime;
  let timerInterval;
  let audioContext;
  let analyser;
  let dataArray;
  let animationId;

  const recordBtn = document.getElementById('record-btn');
  const stopBtn = document.getElementById('stop-btn');
  const previewContainer = document.getElementById('preview-container');
  const audioPreview = document.getElementById('audio-preview');
  const timerDisplay = document.getElementById('timer-display');
  const waveform = document.getElementById('waveform');
  const retryBtn = document.getElementById('retry-btn');
  const saveBtn = document.getElementById('save-btn');

  // Initialize Visualizer Bars
  for(let i=0; i<30; i++) {
    const bar = document.createElement('div');
    bar.className = "w-1 bg-primary rounded-t transition-all duration-75";
    bar.style.height = "10%";
    waveform.appendChild(bar);
  }
  const bars = waveform.children;

  async function startRecording() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      
      // Setup Visualizer
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const source = audioContext.createMediaStreamSource(stream);
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 64;
      source.connect(analyser);
      dataArray = new Uint8Array(analyser.frequencyBinCount);
      
      // Setup Recorder
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = (event) => {
        audioChunks.push(event.data);
      };

      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const audioUrl = URL.createObjectURL(audioBlob);
        audioPreview.src = audioUrl;
        
        // Stop Visualizer
        cancelAnimationFrame(animationId);
        audioContext.close();
        stream.getTracks().forEach(track => track.stop());
        
        // Show Preview
        previewContainer.classList.remove('hidden');
        recordBtn.classList.add('hidden');
        stopBtn.classList.add('hidden');
        
        // Expose blob for parent form
        window.currentHafalanBlob = audioBlob;
      };

      mediaRecorder.start();
      startTime = Date.now();
      updateTimer();
      visualize();

      // UI Updates
      recordBtn.classList.add('hidden');
      stopBtn.classList.remove('hidden');
      previewContainer.classList.add('hidden');

    } catch (err) {
      alert("Gagal mengakses mikrofon. Pastikan izin diberikan.");
      console.error(err);
    }
  }

  function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      mediaRecorder.stop();
      clearInterval(timerInterval);
    }
  }

  function visualize() {
    analyser.getByteFrequencyData(dataArray);
    
    // Update bars height based on frequency
    for(let i=0; i < bars.length; i++) {
      // Map frequency data to bars (simple mapping)
      const value = dataArray[i] || 0;
      const percent = Math.max(10, (value / 255) * 100);
      bars[i].style.height = `${percent}%`;
    }
    
    animationId = requestAnimationFrame(visualize);
  }

  function updateTimer() {
    timerInterval = setInterval(() => {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
      const secs = (elapsed % 60).toString().padStart(2, '0');
      timerDisplay.textContent = `${mins}:${secs}`;

      if (elapsed >= maxDuration) {
        stopRecording();
        alert("Waktu maksimal tercapai.");
      }
    }, 1000);
  }

  recordBtn.addEventListener('click', startRecording);
  stopBtn.addEventListener('click', stopRecording);
  
  retryBtn.addEventListener('click', () => {
    previewContainer.classList.add('hidden');
    recordBtn.classList.remove('hidden');
    timerDisplay.textContent = "00:00";
    // Reset bars
    Array.from(bars).forEach(b => b.style.height = "10%");
  });

  saveBtn.addEventListener('click', () => {
    // Trigger custom event for parent component to handle upload/save
    if (window.currentHafalanBlob) {
      window.dispatchEvent(new CustomEvent('hafalan:saved', { 
        detail: { blob: window.currentHafalanBlob } 
      }));
      saveBtn.textContent = "Tersimpan!";
      saveBtn.disabled = true;
      retryBtn.disabled = true;
    }
  });
</script>