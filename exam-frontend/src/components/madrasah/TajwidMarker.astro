---
// src/components/madrasah/TajwidMarker.astro
interface Props {
  text: string;
  highlightRules?: string[];
}

const { text, highlightRules = ['all'] } = Astro.props;

const tajwidRules = {
  ikhfa: { color: 'yellow', name: 'Ikhfa', description: 'Samar' },
  idgham: { color: 'green', name: 'Idgham', description: 'Memasukkan' },
  qalqalah: { color: 'red', name: 'Qalqalah', description: 'Memantul' },
  ghunnah: { color: 'purple', name: 'Ghunnah', description: 'Dengung' },
  mad: { color: 'blue', name: 'Mad', description: 'Panjang' },
  iqlab: { color: 'orange', name: 'Iqlab', description: 'Membalik' },
};
---

<div class="tajwid-marker">
  <div class="tajwid-legend mb-4">
    <h4 class="mb-2 font-semibold">Keterangan Tajwid:</h4>
    <div class="grid grid-cols-2 gap-2 md:grid-cols-3">
      {
        Object.entries(tajwidRules).map(([key, rule]) => (
          <div class="flex items-center gap-2">
            <div
              class={`h-4 w-4 rounded border-2`}
              style={`background-color: ${rule.color}; opacity: 0.3;`}
            />
            <div>
              <span class="text-sm font-semibold">{rule.name}</span>
              <span class="ml-1 text-xs text-base-content/70">({rule.description})</span>
            </div>
          </div>
        ))
      }
    </div>
  </div>

  <div
    id="marked-text"
    class="rounded-lg bg-base-200 p-4 font-quran text-3xl leading-loose"
    dir="rtl"
  >
    {text}
  </div>

  <div class="mt-4">
    <button type="button" id="toggle-markers" class="btn btn-ghost btn-sm">
      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
        ></path>
      </svg>
      <span id="toggle-text">Sembunyikan Tajwid</span>
    </button>
  </div>
</div>

<script define:vars={{ text, highlightRules }}>
  let showMarkers = true;
  const markedTextEl = document.getElementById('marked-text');
  const toggleBtn = document.getElementById('toggle-markers');
  const toggleText = document.getElementById('toggle-text');

  function applyTajwidMarkers(arabicText, showMarkers) {
    if (!showMarkers) {
      return arabicText;
    }

    const patterns = {
      ikhfa: { pattern: /([نم])\s*([بم])/g, class: 'bg-yellow-200/30' },
      idgham: { pattern: /([نملر])\s*([نملر])/g, class: 'bg-green-200/30' },
      qalqalah: { pattern: /[قطبجد]/g, class: 'bg-red-200/30' },
      ghunnah: { pattern: /[~ّ]/g, class: 'bg-purple-200/30' },
      mad: { pattern: /ا[َُِ]/g, class: 'bg-blue-200/30' },
      iqlab: { pattern: /ن\s*ب/g, class: 'bg-orange-200/30' },
    };

    let result = arabicText;

    Object.entries(patterns).forEach(([rule, config]) => {
      if (highlightRules.includes('all') || highlightRules.includes(rule)) {
        result = result.replace(config.pattern, (match) => {
          return `<span class="${config.class} px-1 rounded" data-tajwid="${rule}">${match}</span>`;
        });
      }
    });

    return result;
  }

  function updateDisplay() {
    if (markedTextEl) {
      markedTextEl.innerHTML = applyTajwidMarkers(text, showMarkers);
    }
    if (toggleText) {
      toggleText.textContent = showMarkers ? 'Sembunyikan Tajwid' : 'Tampilkan Tajwid';
    }
  }

  toggleBtn?.addEventListener('click', () => {
    showMarkers = !showMarkers;
    updateDisplay();
  });

  markedTextEl?.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (target.dataset.tajwid) {
      const ruleName = target.dataset.tajwid;
      showTajwidInfo(ruleName);
    }
  });

  function showTajwidInfo(ruleName) {
    const rules = {
      ikhfa:
        'Ikhfa: Menyamarkan bunyi nun mati atau tanwin ketika bertemu dengan salah satu dari 15 huruf ikhfa.',
      idgham: 'Idgham: Memasukkan bunyi nun mati atau tanwin ke dalam huruf berikutnya.',
      qalqalah: 'Qalqalah: Memantulkan bunyi huruf ketika sukun.',
      ghunnah: 'Ghunnah: Mendengungkan bunyi nun atau mim bertasydid.',
      mad: 'Mad: Memanjangkan bacaan.',
      iqlab: 'Iqlab: Membalik bunyi nun mati menjadi mim ketika bertemu ba.',
    };

    alert(rules[ruleName] || 'Kaidah tajwid');
  }

  updateDisplay();
</script>

<style>
  .font-quran {
    font-family: 'Scheherazade', 'Amiri', serif;
  }

  [data-tajwid] {
    cursor: help;
    transition: all 0.2s;
  }

  [data-tajwid]:hover {
    transform: scale(1.1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
</style>
