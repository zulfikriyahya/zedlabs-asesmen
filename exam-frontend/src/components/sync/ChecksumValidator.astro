---
// src/components/sync/ChecksumValidator.astro
interface Props {
  data: any;
  expectedChecksum: string;
}

const { data, expectedChecksum } = Astro.props;
---

<div class="checksum-validator">
  <div id="validation-status" class="flex items-center gap-2 text-sm">
    <div class="loading loading-spinner loading-sm"></div>
    <span>Memvalidasi integritas data...</span>
  </div>
</div>

<script define:vars={{ data, expectedChecksum }}>
  import { generateChecksum } from '@/lib/offline/checksum';

  const statusEl = document.getElementById('validation-status');

  async function validate() {
    try {
      const actualChecksum = generateChecksum(data);

      if (actualChecksum === expectedChecksum) {
        if (statusEl) {
          statusEl.innerHTML = `
            <svg class="w-5 h-5 text-success" fill="currentColor" viewBox="0 0 20 20">
              <path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
            </svg>
            <span class="text-success">Data valid</span>
          `;
        }
        window.dispatchEvent(new CustomEvent('checksum:valid'));
      } else {
        if (statusEl) {
          statusEl.innerHTML = `
            <svg class="w-5 h-5 text-error" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
            <span class="text-error">Data corrupt!</span>
          `;
        }
        window.dispatchEvent(new CustomEvent('checksum:invalid'));
      }
    } catch (error) {
      console.error('Checksum validation error:', error);
      if (statusEl) {
        statusEl.innerHTML = `
          <svg class="w-5 h-5 text-error" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
          </svg>
          <span class="text-error">Validasi gagal</span>
        `;
      }
    }
  }

  validate();
</script>
