---
// src/components/exam/QuestionNavigation.astro
// Props tidak diperlukan karena data diambil dari Client Store
---

<div class="flex h-full flex-col bg-base-100">
  <div class="p-4 border-b border-base-300">
    <h3 class="font-bold text-lg">Navigasi Soal</h3>
    <div class="flex gap-2 text-xs mt-2">
      <div class="flex items-center gap-1">
        <div class="w-3 h-3 bg-primary rounded"></div> Aktif
      </div>
      <div class="flex items-center gap-1">
        <div class="w-3 h-3 bg-success rounded"></div> Jawab
      </div>
      <div class="flex items-center gap-1">
        <div class="w-3 h-3 bg-warning rounded"></div> Ragu
      </div>
    </div>
  </div>

  <div class="flex-1 overflow-y-auto p-4">
    <!-- Grid container akan diisi oleh script -->
    <div id="nav-grid" class="grid grid-cols-4 gap-2">
      <!-- Skeleton Loading -->
      {Array.from({ length: 20 }).map(() => (
        <div class="aspect-square rounded bg-base-200 animate-pulse"></div>
      ))}
    </div>
  </div>
</div>

<script>
  import { $examUI, $questionStatus, setCurrentIndex } from '@/stores/exam';
  import { ExamController } from '@/lib/exam/controller'; // Asumsi instance global atau akses via event

  const grid = document.getElementById('nav-grid');
  let questionsList: any[] = [];

  // Listen for initialization event from parent page
  window.addEventListener('exam:init-nav', (e: any) => {
    questionsList = e.detail.questions;
    renderGrid();
  });

  function renderGrid() {
    if (!grid || questionsList.length === 0) return;
    
    grid.innerHTML = '';
    
    questionsList.forEach((q, idx) => {
      const btn = document.createElement('button');
      btn.id = `nav-btn-${q.id}`;
      btn.textContent = (idx + 1).toString();
      btn.className = `aspect-square rounded-lg border-2 font-semibold text-sm transition-all hover:brightness-95`;
      
      // Click handler
      btn.onclick = () => {
        // Dispatch event agar Controller di parent page menangkapnya
        window.dispatchEvent(new CustomEvent('exam:goto', { detail: { index: idx } }));
      };

      grid.appendChild(btn);
    });
  }

  // Subscribe to UI changes to update classes efficiently
  // Menggabungkan store UI dan Status Soal
  import { computed } from 'nanostores';

  const $combinedState = computed([$examUI, $questionStatus], (ui, status) => ({
    currentIndex: ui.currentQuestionIndex,
    status
  }));

  $combinedState.subscribe(({ currentIndex, status }) => {
    if (questionsList.length === 0) return;

    questionsList.forEach((q, idx) => {
      const btn = document.getElementById(`nav-btn-${q.id}`);
      if (!btn) return;

      const qStatus = status[q.id] || { answered: false, flagged: false };
      const isCurrent = idx === currentIndex;

      // Reset classes
      let classes = "aspect-square rounded-lg border-2 font-semibold text-sm transition-all ";

      if (isCurrent) {
        classes += "bg-primary text-white border-primary shadow-md scale-105";
      } else if (qStatus.flagged) {
        classes += "bg-warning text-warning-content border-warning";
      } else if (qStatus.answered) {
        classes += "bg-success text-white border-success";
      } else {
        classes += "bg-base-100 border-base-300 text-base-content";
      }

      btn.className = classes;
    });
  });
</script>