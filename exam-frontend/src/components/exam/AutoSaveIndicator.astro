---
// src/components/exam/AutoSaveIndicator.astro
---

<div id="autosave-indicator" class="flex items-center gap-2 text-sm">
  <span id="save-status" class="flex items-center gap-2">
    <!-- Idle State -->
    <span id="status-idle" class="text-base-content/50">
      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"
        ></path>
      </svg>
      <span>Tersimpan</span>
    </span>

    <!-- Saving State -->
    <span id="status-saving" class="hidden text-info">
      <span class="loading loading-spinner loading-sm"></span>
      <span>Menyimpan...</span>
    </span>

    <!-- Saved State -->
    <span id="status-saved" class="hidden text-success">
      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <span>Tersimpan</span>
    </span>

    <!-- Error State -->
    <span id="status-error" class="hidden text-error">
      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <span>Gagal menyimpan</span>
    </span>
  </span>

  <span id="last-saved" class="text-xs text-base-content/50"></span>
</div>

<script>
  import { $answersStore } from '@/stores/answers';

  const statusIdle = document.getElementById('status-idle');
  const statusSaving = document.getElementById('status-saving');
  const statusSaved = document.getElementById('status-saved');
  const statusError = document.getElementById('status-error');
  const lastSavedEl = document.getElementById('last-saved');

  function hideAllStatuses() {
    statusIdle?.classList.add('hidden');
    statusSaving?.classList.add('hidden');
    statusSaved?.classList.add('hidden');
    statusError?.classList.add('hidden');
  }

  function showStatus(status: 'idle' | 'saving' | 'saved' | 'error') {
    hideAllStatuses();

    switch (status) {
      case 'idle':
        statusIdle?.classList.remove('hidden');
        break;
      case 'saving':
        statusSaving?.classList.remove('hidden');
        break;
      case 'saved':
        statusSaved?.classList.remove('hidden');
        updateLastSaved();
        // Auto-hide after 2 seconds
        setTimeout(() => showStatus('idle'), 2000);
        break;
      case 'error':
        statusError?.classList.remove('hidden');
        break;
    }
  }

  function updateLastSaved() {
    if (!lastSavedEl) return;

    const now = new Date();
    const timeStr = now.toLocaleTimeString('id-ID', {
      hour: '2-digit',
      minute: '2-digit',
    });

    lastSavedEl.textContent = `(${timeStr})`;
  }

  // Listen to answer store changes
  let isDirty = false;
  let saveTimeout: number | null = null;

  $answersStore.subscribe((state) => {
    isDirty = state.isDirty;

    if (isDirty) {
      // Clear previous timeout
      if (saveTimeout) {
        clearTimeout(saveTimeout);
      }

      // Show saving after a short delay (debounce)
      saveTimeout = window.setTimeout(() => {
        showStatus('saving');
      }, 500);
    }
  });

  // Listen to save events
  window.addEventListener('exam:save-start', () => {
    showStatus('saving');
  });

  window.addEventListener('exam:save-success', () => {
    showStatus('saved');
  });

  window.addEventListener('exam:save-error', () => {
    showStatus('error');
  });

  // Initialize
  showStatus('idle');
</script>

<style>
  #autosave-indicator {
    user-select: none;
  }
</style>
