---
// src/components/exam/MediaRecorder.astro
interface Props {
  type: 'audio' | 'video';
  maxDuration?: number;
  questionId: number;
}

const { type, maxDuration = 300, questionId } = Astro.props;
---

<div class="media-recorder card bg-base-200">
  <div class="card-body">
    <div class="mb-4 flex items-center justify-between">
      <h3 class="font-bold">
        {type === 'audio' ? 'Rekam Audio' : 'Rekam Video'}
      </h3>
      <div class="font-mono text-lg" id={`rec-timer-${questionId}`}>00:00</div>
    </div>

    {
      type === 'video' && (
        <video
          id={`preview-${questionId}`}
          class="mb-4 h-64 w-full rounded bg-black"
          autoplay
          muted
          playsinline
        />
      )
    }

    {
      type === 'audio' && (
        <div class="mb-4 flex h-32 items-center justify-center rounded bg-base-300">
          <div id={`audio-visualizer-${questionId}`} class="flex h-20 items-end gap-1">
            {Array.from({ length: 20 }).map((_, i) => (
              <div class="bg-primary w-1 rounded-t" style={`height: ${Math.random() * 100}%`} />
            ))}
          </div>
        </div>
      )
    }

    <div class="flex justify-center gap-2">
      <button id={`start-rec-${questionId}`} type="button" class="btn btn-error">
        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
          <circle cx="10" cy="10" r="6"></circle>
        </svg>
        Mulai Rekam
      </button>

      <button id={`stop-rec-${questionId}`} type="button" class="btn btn-primary" disabled>
        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
          <rect x="6" y="6" width="8" height="8"></rect>
        </svg>
        Stop
      </button>

      <button id={`retry-rec-${questionId}`} type="button" class="btn btn-ghost" disabled>
        Ulangi
      </button>
    </div>

    <div id={`playback-area-${questionId}`} class="mt-4 hidden">
      <h4 class="mb-2 font-semibold">Preview Rekaman</h4>
      {
        type === 'audio' ? (
          <audio id={`playback-audio-${questionId}`} class="w-full" controls />
        ) : (
          <video id={`playback-video-${questionId}`} class="w-full rounded" controls playsinline />
        )
      }

      <div class="mt-2 flex justify-end gap-2">
        <button id={`confirm-rec-${questionId}`} type="button" class="btn btn-success">
          Gunakan Rekaman Ini
        </button>
      </div>
    </div>
  </div>
</div>

<script define:vars={{ type, maxDuration, questionId }}>
  let mediaRecorder;
  let recordedChunks = [];
  let stream;
  let startTime;
  let timerInterval;
  let recordingBlob;
  let audioContext;
  let analyser;
  let dataArray;
  let animationFrame;

  const startBtn = document.getElementById(`start-rec-${questionId}`);
  const stopBtn = document.getElementById(`stop-rec-${questionId}`);
  const retryBtn = document.getElementById(`retry-rec-${questionId}`);
  const confirmBtn = document.getElementById(`confirm-rec-${questionId}`);
  const timerEl = document.getElementById(`rec-timer-${questionId}`);
  const playbackArea = document.getElementById(`playback-area-${questionId}`);

  startBtn?.addEventListener('click', startRecording);
  stopBtn?.addEventListener('click', stopRecording);
  retryBtn?.addEventListener('click', retryRecording);
  confirmBtn?.addEventListener('click', confirmRecording);

  async function startRecording() {
    try {
      const constraints =
        type === 'audio'
          ? { audio: { echoCancellation: true, noiseSuppression: true } }
          : {
              audio: { echoCancellation: true, noiseSuppression: true },
              video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } },
            };

      stream = await navigator.mediaDevices.getUserMedia(constraints);

      if (type === 'video') {
        const preview = document.getElementById(`preview-${questionId}`);
        if (preview) preview.srcObject = stream;
      } else {
        setupAudioVisualizer(stream);
      }

      const mimeType = type === 'audio' ? 'audio/webm;codecs=opus' : 'video/webm;codecs=vp9';

      const options = { mimeType };
      mediaRecorder = new MediaRecorder(stream, options);

      mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
          recordedChunks.push(event.data);
        }
      };

      mediaRecorder.onstop = handleRecordingStop;

      recordedChunks = [];
      mediaRecorder.start();
      startTime = Date.now();

      startBtn.disabled = true;
      stopBtn.disabled = false;
      retryBtn.disabled = true;
      playbackArea.classList.add('hidden');

      updateTimer();
      timerInterval = setInterval(updateTimer, 1000);

      setTimeout(() => {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
          stopRecording();
          alert(`Durasi maksimal ${maxDuration / 60} menit tercapai.`);
        }
      }, maxDuration * 1000);
    } catch (error) {
      console.error('Failed to start recording:', error);
      alert('Gagal memulai rekaman. Pastikan izin mikrofon/kamera sudah diberikan.');
    }
  }

  function setupAudioVisualizer(audioStream) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    const source = audioContext.createMediaStreamSource(audioStream);
    source.connect(analyser);
    analyser.fftSize = 64;
    dataArray = new Uint8Array(analyser.frequencyBinCount);
    visualize();
  }

  function visualize() {
    const visualizer = document.getElementById(`audio-visualizer-${questionId}`);
    if (!visualizer || !analyser) return;

    analyser.getByteFrequencyData(dataArray);

    const bars = visualizer.children;
    for (let i = 0; i < bars.length && i < dataArray.length; i++) {
      const height = (dataArray[i] / 255) * 100;
      bars[i].style.height = `${Math.max(height, 10)}%`;
    }

    animationFrame = requestAnimationFrame(visualize);
  }

  function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      mediaRecorder.stop();

      stream.getTracks().forEach((track) => track.stop());

      if (timerInterval) clearInterval(timerInterval);
      if (animationFrame) cancelAnimationFrame(animationFrame);
      if (audioContext) audioContext.close();

      startBtn.disabled = false;
      stopBtn.disabled = true;
      retryBtn.disabled = false;
    }
  }

  function handleRecordingStop() {
    const mimeType = type === 'audio' ? 'audio/webm' : 'video/webm';
    recordingBlob = new Blob(recordedChunks, { type: mimeType });

    const playbackEl =
      type === 'audio'
        ? document.getElementById(`playback-audio-${questionId}`)
        : document.getElementById(`playback-video-${questionId}`);

    if (playbackEl) {
      playbackEl.src = URL.createObjectURL(recordingBlob);
      playbackArea.classList.remove('hidden');
    }
  }

  function retryRecording() {
    recordedChunks = [];
    recordingBlob = null;
    if (timerEl) timerEl.textContent = '00:00';
    playbackArea.classList.add('hidden');
    startRecording();
  }

  function confirmRecording() {
    if (!recordingBlob) return;

    const duration = (Date.now() - startTime) / 1000;

    window.dispatchEvent(
      new CustomEvent('recording-complete', {
        detail: {
          blob: recordingBlob,
          duration,
          type,
          questionId,
        },
      })
    );

    const event = new CustomEvent('media-recorded', {
      detail: {
        questionId,
        blob: recordingBlob,
        type,
        duration,
      },
    });
    window.dispatchEvent(event);
  }

  function updateTimer() {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;

    if (timerEl) {
      timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    const remaining = maxDuration - elapsed;
    if (remaining <= 60) {
      timerEl?.classList.add('text-error');
    } else if (remaining <= 120) {
      timerEl?.classList.add('text-warning');
    }
  }
</script>

<style>
  #audio-visualizer > div {
    transition: height 0.1s ease;
  }
</style>
