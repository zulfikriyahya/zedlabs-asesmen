---
// src/components/exam/QuestionTypes/Matching.astro
interface Props {
  question: {
    id: number;
    question_text: string;
    question_html?: string;
    media_url?: string;
    media_type?: 'image' | 'audio' | 'video';
    pairs: Array<{
      id: number;
      left_text: string;
      right_text: string;
      left_media_url?: string;
      right_media_url?: string;
    }>;
  };
  savedAnswer?: Record<number, number>; // left_id => right_id
  readonly?: boolean;
}

const { question, savedAnswer = {}, readonly = false } = Astro.props;

// Shuffle right items for display
const rightItems = [...question.pairs].sort(() => Math.random() - 0.5);
---

<div class="question-container space-y-6">
  <!-- Question Text -->
  <div class="question-text prose max-w-none">
    {question.question_html ? (
      <div set:html={question.question_html} />
    ) : (
      <p class="text-lg">{question.question_text}</p>
    )}
    
    <div class="alert alert-info mt-4">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <span class="text-sm">Pasangkan item di sebelah kiri dengan item di sebelah kanan yang sesuai</span>
    </div>
  </div>

  <!-- Question Media -->
  {question.media_url && (
    <div class="question-media">
      {question.media_type === 'image' && (
        <img 
          src={question.media_url} 
          alt="Question media"
          class="max-w-full rounded-lg shadow-lg"
        />
      )}
    </div>
  )}

  <!-- Matching Interface -->
  <div class="matching-container grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Left Column -->
    <div class="left-column space-y-3">
      <h4 class="font-semibold mb-4">Kolom A</h4>
      {question.pairs.map((pair, index) => (
        <div class="matching-item-left p-4 bg-base-200 rounded-lg">
          <div class="flex items-start gap-3">
            <span class="badge badge-primary">{index + 1}</span>
            <div class="flex-1">
              <p>{pair.left_text}</p>
              {pair.left_media_url && (
                <img 
                  src={pair.left_media_url} 
                  alt="Left item" 
                  class="mt-2 max-w-xs rounded"
                />
              )}
            </div>
          </div>
          
          <!-- Match Selection -->
          <div class="mt-3">
            <select
              name={`match-${pair.id}`}
              class="select select-bordered select-sm w-full"
              data-left-id={pair.id}
              data-answer-input
              disabled={readonly}
            >
              <option value="">Pilih pasangan...</option>
              {rightItems.map((right, idx) => (
                <option 
                  value={right.id}
                  selected={savedAnswer[pair.id] === right.id}
                >
                  {String.fromCharCode(65 + idx)}) {right.right_text.substring(0, 50)}...
                </option>
              ))}
            </select>
          </div>
        </div>
      ))}
    </div>

    <!-- Right Column -->
    <div class="right-column space-y-3">
      <h4 class="font-semibold mb-4">Kolom B</h4>
      {rightItems.map((item, index) => (
        <div 
          class="matching-item-right p-4 bg-base-200 rounded-lg border-2 border-dashed border-base-300"
          data-right-id={item.id}
        >
          <div class="flex items-start gap-3">
            <span class="badge badge-outline">{String.fromCharCode(65 + index)}</span>
            <div class="flex-1">
              <p>{item.right_text}</p>
              {item.right_media_url && (
                <img 
                  src={item.right_media_url} 
                  alt="Right item" 
                  class="mt-2 max-w-xs rounded"
                />
              )}
            </div>
          </div>
        </div>
      ))}
    </div>
  </div>

  <!-- Progress Indicator -->
  <div class="text-sm text-base-content/70 text-center">
    <span id="match-progress">0</span> dari {question.pairs.length} pasangan selesai
  </div>
</div>

<script>
  // Track matching progress
  const selects = document.querySelectorAll('select[data-answer-input]');
  const progressEl = document.getElementById('match-progress');
  
  function updateProgress() {
    const matched = Array.from(selects).filter(s => (s as HTMLSelectElement).value !== '').length;
    if (progressEl) {
      progressEl.textContent = matched.toString();
    }
  }
  
  selects.forEach(select => {
    select.addEventListener('change', () => {
      updateProgress();
      
      // Visual feedback
      const leftItem = select.closest('.matching-item-left');
      if (select.value) {
        leftItem?.classList.add('border-2', 'border-success');
      } else {
        leftItem?.classList.remove('border-2', 'border-success');
      }
    });
  });
  
  // Initialize
  updateProgress();
</script>

<style>
  .matching-item-left {
    transition: all 0.2s ease;
  }
</style>