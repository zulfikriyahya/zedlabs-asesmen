---
import MediaUpload from './MediaUpload.astro';
import OptionsEditor from './OptionsEditor.astro';
import MatchingEditor from './MatchingEditor.astro';

interface Props {
  examId: string;
  initialData?: any;
  mode?: 'create' | 'edit';
}

const { examId, initialData, mode = 'create' } = Astro.props;
---

<form id="question-form" class="space-y-6">
  <!-- Hidden Fields -->
  <input type="hidden" name="exam_id" value={examId} />
  
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    
    <!-- Left Column: Settings -->
    <div class="space-y-6">
      <div class="card bg-base-100 shadow-lg">
        <div class="card-body p-4">
          <h3 class="font-bold text-sm uppercase text-base-content/50 mb-2">Pengaturan Soal</h3>
          
          <div class="form-control w-full">
            <label class="label"><span class="label-text">Tipe Soal</span></label>
            <select name="type" id="type-select" class="select select-bordered w-full" disabled={mode==='edit'}>
              <option value="multiple_choice" selected={initialData?.type === 'multiple_choice'}>Pilihan Ganda</option>
              <option value="multiple_choice_complex" selected={initialData?.type === 'multiple_choice_complex'}>Pilihan Ganda Kompleks</option>
              <option value="true_false" selected={initialData?.type === 'true_false'}>Benar / Salah</option>
              <option value="matching" selected={initialData?.type === 'matching'}>Menjodohkan</option>
              <option value="short_answer" selected={initialData?.type === 'short_answer'}>Isian Singkat</option>
              <option value="essay" selected={initialData?.type === 'essay'}>Uraian (Esai)</option>
            </select>
          </div>

          <div class="form-control w-full mt-2">
            <label class="label"><span class="label-text">Bobot Poin</span></label>
            <input type="number" name="points" value={initialData?.points || 1} min="0" class="input input-bordered w-full" />
          </div>

          <div class="divider"></div>

          <div class="form-control">
            <label class="label cursor-pointer">
              <span class="label-text">Acak Opsi Jawaban</span>
              <input type="checkbox" name="randomize_options" class="toggle toggle-sm toggle-primary" checked={initialData?.randomize_options ?? true} />
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column: Content -->
    <div class="lg:col-span-2 space-y-6">
      
      <!-- Question Text & Media -->
      <div class="card bg-base-100 shadow-lg">
        <div class="card-body">
          <div class="form-control">
            <label class="label"><span class="label-text font-bold">Pertanyaan</span></label>
            <!-- In real app, use a Rich Text Editor like Tiptap/Quill here -->
            <textarea 
              name="question_text" 
              class="textarea textarea-bordered h-32 text-base leading-relaxed" 
              placeholder="Tulis pertanyaan di sini..." 
              required
            >{initialData?.question_text || ''}</textarea>
          </div>

          <div class="collapse collapse-arrow border border-base-300 bg-base-100 rounded-box mt-4">
            <input type="checkbox" /> 
            <div class="collapse-title text-sm font-medium">
              + Tambah Media (Gambar/Audio/Video)
            </div>
            <div class="collapse-content">
              <MediaUpload id="q-media" label="Upload Media Soal" />
            </div>
          </div>
        </div>
      </div>

      <!-- Dynamic Answer Editor Area -->
      <div class="card bg-base-100 shadow-lg border-t-4 border-primary">
        <div class="card-body">
          <h3 class="card-title text-base mb-4">Kunci Jawaban</h3>
          
          <div id="editor-container">
            <!-- Content injected by JS based on Type -->
            <div id="placeholder-editor" class="text-center py-8 text-base-content/50">
              Pilih tipe soal untuk mengatur jawaban
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex justify-end gap-4 pb-10">
        <button type="button" onclick="history.back()" class="btn btn-ghost">Batal</button>
        <button type="submit" class="btn btn-primary w-32">Simpan</button>
      </div>

    </div>
  </div>
</form>

<!-- Templates for Editors -->
<div class="hidden">
  <template id="tpl-options-editor">
    <OptionsEditor initialOptions={initialData?.options} />
  </template>
  
  <template id="tpl-matching-editor">
    <MatchingEditor initialPairs={initialData?.pairs} />
  </template>

  <template id="tpl-essay-editor">
    <div class="alert alert-info">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
      <span>Soal Uraian dikoreksi secara manual oleh guru.</span>
    </div>
    <div class="form-control mt-4">
      <label class="label"><span class="label-text">Kunci Jawaban / Pedoman Penilaian (Opsional)</span></label>
      <textarea name="answer_key" class="textarea textarea-bordered h-24" placeholder="Tulis poin-poin penting jawaban..."></textarea>
    </div>
  </template>
</div>

<script>
  import { createQuestion, updateQuestion } from '@/lib/api/question';

  const typeSelect = document.getElementById('type-select');
  const editorContainer = document.getElementById('editor-container');
  const form = document.getElementById('question-form');

  // Mapping templates
  const templates = {
    multiple_choice: 'tpl-options-editor',
    multiple_choice_complex: 'tpl-options-editor', // Re-use but change validation logic
    true_false: 'tpl-options-editor', // Simplified options
    matching: 'tpl-matching-editor',
    essay: 'tpl-essay-editor',
    short_answer: 'tpl-essay-editor' // Similar structure
  };

  function loadEditor(type) {
    editorContainer.innerHTML = '';
    const tplId = templates[type];
    if (tplId) {
      const tpl = document.getElementById(tplId);
      const clone = tpl.content.cloneNode(true);
      
      // Special logic for True/False to prepopulate if empty
      if (type === 'true_false' && !form.dataset.initialized) {
        // Logic to force 2 options: Benar & Salah
      }

      editorContainer.appendChild(clone);
    }
  }

  typeSelect.addEventListener('change', (e) => {
    loadEditor(e.target.value);
  });

  // Initial Load
  loadEditor(typeSelect.value);

  // Form Submit
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    
    // Collect dynamic data from child components
    // NOTE: Child components (OptionsEditor) should append hidden inputs to this form
    // or we gather data manually here.
    
    // Example gathering options manually if they are not inputs
    const options = [];
    document.querySelectorAll('.option-item').forEach((item, idx) => {
      options.push({
        text: item.querySelector('.option-text').value,
        is_correct: item.querySelector('input[type="radio"], input[type="checkbox"]').checked
      });
    });

    const payload = {
      ...Object.fromEntries(formData),
      options: options // Add processed options
    };

    try {
      // Logic create/update
      alert('Simulasi: Data tersimpan (Lihat console)');
      console.log(payload);
      // await createQuestion(payload);
      // window.location.href = `/guru/soal`;
    } catch (err) {
      alert('Gagal menyimpan soal');
    }
  });
</script>