---
// src/components/analytics/StudentProgress.astro
interface Props {
  studentId: number;
  progress: Array<{
    examId: number;
    examTitle: string;
    score: number;
    maxScore: number;
    completedAt: string;
    rank: number;
    totalParticipants: number;
  }>;
}

const { studentId, progress } = Astro.props;

const averageScore =
  progress.length > 0
    ? progress.reduce((sum, p) => sum + (p.score / p.maxScore) * 100, 0) / progress.length
    : 0;
---

<div class="space-y-6">
  <!-- Summary -->
  <div class="card bg-base-200">
    <div class="card-body">
      <h3 class="card-title">Ringkasan Progres</h3>
      <div class="mt-4 grid grid-cols-1 gap-4 md:grid-cols-3">
        <div>
          <p class="text-sm text-base-content/70">Total Ujian</p>
          <p class="text-2xl font-bold">{progress.length}</p>
        </div>
        <div>
          <p class="text-sm text-base-content/70">Rata-rata Nilai</p>
          <p class="text-2xl font-bold">{averageScore.toFixed(1)}%</p>
        </div>
        <div>
          <p class="text-sm text-base-content/70">Peringkat Rata-rata</p>
          <p class="text-2xl font-bold">
            {
              progress.length > 0
                ? Math.round(progress.reduce((sum, p) => sum + p.rank, 0) / progress.length)
                : '-'
            }
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Progress Chart -->
  <div class="card bg-base-200">
    <div class="card-body">
      <h3 class="card-title">Grafik Perkembangan</h3>
      <canvas id="progress-chart" class="max-h-80"></canvas>
    </div>
  </div>

  <!-- Exam History -->
  <div class="card bg-base-200">
    <div class="card-body">
      <h3 class="card-title">Riwayat Ujian</h3>
      <div class="mt-4 overflow-x-auto">
        <table class="table">
          <thead>
            <tr>
              <th>Ujian</th>
              <th>Nilai</th>
              <th>Peringkat</th>
              <th>Tanggal</th>
            </tr>
          </thead>
          <tbody>
            {
              progress.map((p) => (
                <tr>
                  <td>{p.examTitle}</td>
                  <td>
                    <div class="flex items-center gap-2">
                      <span class="font-semibold">
                        {p.score}/{p.maxScore}
                      </span>
                      <span class="text-sm text-base-content/70">
                        ({((p.score / p.maxScore) * 100).toFixed(1)}%)
                      </span>
                    </div>
                  </td>
                  <td>
                    <span class="badge badge-outline">
                      {p.rank} dari {p.totalParticipants}
                    </span>
                  </td>
                  <td>
                    {new Date(p.completedAt).toLocaleDateString('id-ID', {
                      year: 'numeric',
                      month: 'short',
                      day: 'numeric',
                    })}
                  </td>
                </tr>
              ))
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script define:vars={{ progress }}>
  import { Chart } from 'chart.js/auto';

  const ctx = document.getElementById('progress-chart');

  if (ctx && progress.length > 0) {
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: progress.map((p) => {
          const date = new Date(p.completedAt);
          return date.toLocaleDateString('id-ID', { month: 'short', day: 'numeric' });
        }),
        datasets: [
          {
            label: 'Nilai (%)',
            data: progress.map((p) => (p.score / p.maxScore) * 100),
            borderColor: 'rgb(59, 130, 246)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            fill: true,
          },
          {
            label: 'Peringkat (inverted)',
            data: progress.map((p) => {
              // Invert rank so lower is better
              return 100 - (p.rank / p.totalParticipants) * 100;
            }),
            borderColor: 'rgb(34, 197, 94)',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            tension: 0.4,
            fill: true,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: {
            callbacks: {
              label: (context) => {
                if (context.datasetIndex === 0) {
                  return `Nilai: ${context.parsed.y.toFixed(1)}%`;
                } else {
                  const rankIndex = context.dataIndex;
                  const rank = progress[rankIndex].rank;
                  const total = progress[rankIndex].totalParticipants;
                  return `Peringkat: ${rank} dari ${total}`;
                }
              },
            },
          },
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
          },
        },
      },
    });
  }
</script>
