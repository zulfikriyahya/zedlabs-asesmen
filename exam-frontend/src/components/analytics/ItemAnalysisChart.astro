---
// src/components/analytics/ItemAnalysisChart.astro
interface Props {
  examId: number;
  questions: Array<{
    id: number;
    number: number;
    difficulty: number;
    discrimination: number;
    type: string;
  }>;
}

const { examId, questions } = Astro.props;
---

<div class="card bg-base-200">
  <div class="card-body">
    <div class="mb-4 flex items-center justify-between">
      <h3 class="card-title">Analisis Butir Soal</h3>
      <div class="text-sm text-base-content/70">
        <span class="mr-4">D: Difficulty Index (0-1)</span>
        <span>Disc: Discrimination Index (-1 to 1)</span>
      </div>
    </div>

    <canvas id="item-analysis-chart" class="max-h-96"></canvas>

    <!-- Legend -->
    <div class="mt-4 grid grid-cols-1 gap-2 text-sm md:grid-cols-3">
      <div class="flex items-center gap-2">
        <div class="h-4 w-4 rounded-full bg-success"></div>
        <span>Baik (D: 0.3-0.7, Disc > 0.3)</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="h-4 w-4 rounded-full bg-warning"></div>
        <span>Perlu Revisi (D atau Disc kurang)</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="h-4 w-4 rounded-full bg-error"></div>
        <span>Buang (Disc < 0)</span>
      </div>
    </div>

    <!-- Question Details Table -->
    <div class="mt-6 overflow-x-auto">
      <table class="table table-sm">
        <thead>
          <tr>
            <th>No</th>
            <th>Tipe</th>
            <th>Difficulty</th>
            <th>Discrimination</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {
            questions.map((q) => {
              const isGood = q.difficulty >= 0.3 && q.difficulty <= 0.7 && q.discrimination > 0.3;
              const needsRevision = !isGood && q.discrimination >= 0;
              const shouldDiscard = q.discrimination < 0;

              return (
                <tr>
                  <td>{q.number}</td>
                  <td>{q.type}</td>
                  <td>{q.difficulty.toFixed(2)}</td>
                  <td>{q.discrimination.toFixed(2)}</td>
                  <td>
                    {isGood && <span class="badge badge-success badge-sm">Baik</span>}
                    {needsRevision && <span class="badge badge-warning badge-sm">Revisi</span>}
                    {shouldDiscard && <span class="badge badge-error badge-sm">Buang</span>}
                  </td>
                </tr>
              );
            })
          }
        </tbody>
      </table>
    </div>
  </div>
</div>

<script define:vars={{ questions }}>
  import { Chart } from 'chart.js/auto';

  const ctx = document.getElementById('item-analysis-chart');

  if (ctx) {
    new Chart(ctx, {
      type: 'scatter',
      data: {
        datasets: [
          {
            label: 'Soal',
            data: questions.map((q) => ({
              x: q.difficulty,
              y: q.discrimination,
              questionNumber: q.number,
              type: q.type,
            })),
            backgroundColor: questions.map((q) => {
              const isGood = q.difficulty >= 0.3 && q.difficulty <= 0.7 && q.discrimination > 0.3;
              const shouldDiscard = q.discrimination < 0;

              if (shouldDiscard) return 'rgba(239, 68, 68, 0.6)';
              if (isGood) return 'rgba(34, 197, 94, 0.6)';
              return 'rgba(251, 191, 36, 0.6)';
            }),
            pointRadius: 8,
            pointHoverRadius: 10,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: {
            callbacks: {
              label: (context) => {
                const point = context.raw;
                return [
                  `Soal #${point.questionNumber}`,
                  `Tipe: ${point.type}`,
                  `Difficulty: ${point.x.toFixed(2)}`,
                  `Discrimination: ${point.y.toFixed(2)}`,
                ];
              },
            },
          },
          legend: {
            display: false,
          },
        },
        scales: {
          x: {
            title: {
              display: true,
              text: 'Difficulty Index (P)',
            },
            min: 0,
            max: 1,
            ticks: {
              stepSize: 0.1,
            },
          },
          y: {
            title: {
              display: true,
              text: 'Discrimination Index (D)',
            },
            min: -1,
            max: 1,
            ticks: {
              stepSize: 0.2,
            },
          },
        },
      },
    });
  }
</script>
