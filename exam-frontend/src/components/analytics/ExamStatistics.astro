---
// src/components/analytics/ExamStatistics.astro
interface Props {
  examId: number;
  statistics: {
    totalParticipants: number;
    submitted: number;
    averageScore: number;
    highestScore: number;
    lowestScore: number;
    passingRate: number;
    averageTime: number;
  };
}

const { examId, statistics } = Astro.props;
---

<div class="space-y-6">
  <!-- Summary Cards -->
  <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
    <div class="card bg-base-200">
      <div class="card-body">
        <h3 class="card-title text-sm">Peserta</h3>
        <p class="text-3xl font-bold">{statistics.totalParticipants}</p>
        <p class="text-sm text-base-content/70">
          {statistics.submitted} sudah submit
        </p>
      </div>
    </div>

    <div class="card bg-base-200">
      <div class="card-body">
        <h3 class="card-title text-sm">Nilai Rata-rata</h3>
        <p class="text-3xl font-bold">{statistics.averageScore.toFixed(1)}</p>
        <div class="text-sm text-base-content/70">
          <span>Tertinggi: {statistics.highestScore}</span>
          <span class="mx-2">â€¢</span>
          <span>Terendah: {statistics.lowestScore}</span>
        </div>
      </div>
    </div>

    <div class="card bg-base-200">
      <div class="card-body">
        <h3 class="card-title text-sm">Kelulusan</h3>
        <p class="text-3xl font-bold">{statistics.passingRate.toFixed(1)}%</p>
        <p class="text-sm text-base-content/70">
          Rata-rata waktu: {Math.floor(statistics.averageTime / 60)} menit
        </p>
      </div>
    </div>
  </div>

  <!-- Score Distribution Chart -->
  <div class="card bg-base-200">
    <div class="card-body">
      <h3 class="card-title">Distribusi Nilai</h3>
      <canvas id="score-distribution-chart"></canvas>
    </div>
  </div>

  <!-- Item Analysis Chart -->
  <div class="card bg-base-200">
    <div class="card-body">
      <h3 class="card-title">Analisis Butir Soal</h3>
      <canvas id="item-analysis-chart"></canvas>
    </div>
  </div>
</div>

<script>
  import { Chart } from 'chart.js/auto';

  // Load chart data from API
  async function loadCharts() {
    try {
      const examId = window.location.pathname.split('/').pop();
      const response = await fetch(`/api/exams/${examId}/analytics`);
      const data = await response.json();

      // Score Distribution Chart
      const scoreCtx = document.getElementById('score-distribution-chart') as HTMLCanvasElement;
      new Chart(scoreCtx, {
        type: 'bar',
        data: {
          labels: [
            '0-10',
            '11-20',
            '21-30',
            '31-40',
            '41-50',
            '51-60',
            '61-70',
            '71-80',
            '81-90',
            '91-100',
          ],
          datasets: [
            {
              label: 'Jumlah Siswa',
              data: data.scoreDistribution,
              backgroundColor: 'rgba(59, 130, 246, 0.5)',
              borderColor: 'rgb(59, 130, 246)',
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1 },
            },
          },
        },
      });

      // Item Analysis Chart
      const itemCtx = document.getElementById('item-analysis-chart') as HTMLCanvasElement;
      new Chart(itemCtx, {
        type: 'scatter',
        data: {
          datasets: [
            {
              label: 'Soal',
              data: data.itemAnalysis,
              backgroundColor: 'rgba(34, 197, 94, 0.5)',
              pointRadius: 6,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: { display: true, text: 'Difficulty Index' },
              min: 0,
              max: 1,
            },
            y: {
              title: { display: true, text: 'Discrimination Index' },
              min: -1,
              max: 1,
            },
          },
        },
      });
    } catch (error) {
      console.error('Failed to load charts:', error);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadCharts);
  } else {
    loadCharts();
  }
</script>

<style>
  canvas {
    max-height: 400px;
  }
</style>
