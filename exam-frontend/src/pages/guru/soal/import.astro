---
import DashboardLayout from '@/layouts/Dashboard.astro';
---

<DashboardLayout title="Import Soal dari Excel" role="guru">
  <div class="max-w-2xl mx-auto">
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 class="card-title mb-4">Upload Bank Soal</h2>
        
        <div class="alert alert-info mb-6">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
          <div>
            <h3 class="font-bold">Format Excel</h3>
            <div class="text-xs">Pastikan format sesuai template. Gambar harus diupload terpisah atau via URL.</div>
            <a href="/templates/template_soal.xlsx" class="link link-primary text-xs font-bold">Download Template Soal</a>
          </div>
        </div>

        <form id="import-form" class="space-y-6">
          <div class="form-control w-full">
            <label class="label">
              <span class="label-text">Pilih File Excel (.xlsx)</span>
            </label>
            <input type="file" name="file" class="file-input file-input-bordered w-full" accept=".xlsx,.xls" required />
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text">Bank Soal Tujuan (Opsional)</span>
            </label>
            <select name="exam_id" class="select select-bordered">
              <option value="">Buat Bank Soal Baru</option>
              <option value="1">Matematika X-A</option>
              <option value="2">Biologi XI-IPA</option>
            </select>
          </div>

          <div class="card-actions justify-end">
            <a href="/guru/soal" class="btn btn-ghost">Batal</a>
            <button type="submit" class="btn btn-primary">
              <span class="loading loading-spinner loading-sm hidden" id="loading-spinner"></span>
              Upload & Proses
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    import { importQuestions } from '@/lib/api/question';

    const form = document.getElementById('import-form') as HTMLFormElement;
    const spinner = document.getElementById('loading-spinner');

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const file = formData.get('file') as File;
      const examId = formData.get('exam_id') ? parseInt(formData.get('exam_id') as string) : undefined;

      if (!file) return;

      try {
        spinner?.classList.remove('hidden');
        await importQuestions(file, examId);
        alert('Import berhasil!');
        window.location.href = '/guru/soal';
      } catch (error) {
        console.error(error);
        alert('Gagal mengimport soal.');
      } finally {
        spinner?.classList.add('hidden');
      }
    });
  </script>
</DashboardLayout>