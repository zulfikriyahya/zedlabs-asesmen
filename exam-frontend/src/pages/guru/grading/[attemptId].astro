---
import DashboardLayout from '@/layouts/Dashboard.astro';
import ManualGradingCard from '@/components/grading/ManualGradingCard.astro';

const { attemptId } = Astro.params;

// Mock Data Fetching (Replace with API call)
const attemptData = {
  id: Number(attemptId),
  student_name: 'Budi Santoso',
  student_id: '12345',
};

const questionsToGrade = [
  {
    question: { 
      id: 1, 
      question_text: 'Jelaskan dampak pemanasan global!', 
      type: 'essay', 
      points: 10 
    },
    answer: { 
      id: 101, 
      answer_text: 'Dampaknya adalah suhu bumi meningkat dan es mencair.' 
    }
  },
  {
    question: { 
      id: 2, 
      question_text: 'Bacakan Surah Al-Fatihah', 
      type: 'essay', 
      points: 20 
    },
    answer: { 
      id: 102, 
      answer_media_url: '/sample-audio.mp3', 
      answer_media_type: 'audio' 
    }
  }
];
---

<DashboardLayout title={`Koreksi: ${attemptData.student_name}`} role="guru">
  <div class="max-w-4xl mx-auto space-y-8">
    <div class="flex justify-between items-center">
      <a href="/guru/grading" class="btn btn-ghost gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
        Kembali ke Daftar
      </a>
      <div class="text-sm">
        Progress: <span id="grading-progress">1</span> / {questionsToGrade.length}
      </div>
    </div>

    <div id="grading-container">
      <!-- Only show first question initially, JS handles navigation -->
      {questionsToGrade.map((item, index) => (
        <div class={`grading-item ${index !== 0 ? 'hidden' : ''}`} data-index={index}>
          <ManualGradingCard 
            attempt={attemptData}
            question={item.question}
            answer={item.answer as any}
          />
        </div>
      ))}
    </div>

    <div id="completion-message" class="hidden card bg-base-100 shadow-xl text-center p-8">
      <h3 class="text-xl font-bold text-success mb-4">Semua soal telah dinilai!</h3>
      <button id="finish-grading-btn" class="btn btn-primary">Simpan & Selesai</button>
    </div>
  </div>

  <script>
    import { submitGrade, finishGradingAttempt } from '@/lib/api/grading';

    let currentIndex = 0;
    const items = document.querySelectorAll('.grading-item');
    const total = items.length;
    const attemptId = window.location.pathname.split('/').pop();

    window.addEventListener('rubric-selected', async (e: any) => {
      // Handle rubric selection (update local state)
      console.log('Score selected:', e.detail);
    });

    window.addEventListener('save-grade', async () => {
      // Logic to save grade to API
      // await submitGrade(...)
      
      // Move to next
      items[currentIndex].classList.add('hidden');
      currentIndex++;
      
      if (currentIndex < total) {
        items[currentIndex].classList.remove('hidden');
        document.getElementById('grading-progress')!.textContent = (currentIndex + 1).toString();
      } else {
        document.getElementById('grading-container')!.classList.add('hidden');
        document.getElementById('completion-message')!.classList.remove('hidden');
      }
    });

    document.getElementById('finish-grading-btn')?.addEventListener('click', async () => {
      if(attemptId) {
        await finishGradingAttempt(parseInt(attemptId));
        window.location.href = '/guru/grading';
      }
    });
  </script>
</DashboardLayout>