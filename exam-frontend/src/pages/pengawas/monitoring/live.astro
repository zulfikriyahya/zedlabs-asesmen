---
import DashboardLayout from '@/layouts/Dashboard.astro';
import LiveMonitor from '@/components/monitoring/LiveMonitor.astro';
import Select from '@/components/ui/Select.astro';

// Fetch active sessions (Server Side)
// const sessions = await getActiveSessions(); 
// Mock data:
const sessions = [
  { value: 1, label: 'Sesi 1 - Matematika X-A' },
  { value: 2, label: 'Sesi 1 - Biologi XI-IPA' }
];
---

<DashboardLayout title="Live Monitoring" role="pengawas">
  <div class="flex flex-col h-[calc(100vh-8rem)]">
    
    <!-- Filter Bar -->
    <div class="bg-base-100 p-4 rounded-lg shadow mb-4 flex gap-4 items-end">
      <div class="w-64">
        <Select 
          name="session_id" 
          label="Pilih Sesi Ujian" 
          options={sessions}
        />
      </div>
      <button id="load-session-btn" class="btn btn-primary">Muat Data</button>
    </div>

    <!-- Monitor Area -->
    <div id="monitor-container" class="flex-1 overflow-hidden relative">
      <div class="absolute inset-0 flex items-center justify-center text-base-content/30">
        <p class="text-lg">Pilih sesi untuk mulai memantau</p>
      </div>
    </div>

  </div>

  <script>
    const loadBtn = document.getElementById('load-session-btn');
    const select = document.getElementById('session_id') as HTMLSelectElement;
    const container = document.getElementById('monitor-container');

    loadBtn?.addEventListener('click', () => {
      const sessionId = select.value;
      if (!sessionId || !container) return;

      // Clear container
      container.innerHTML = '<div class="flex justify-center p-10"><span class="loading loading-spinner loading-lg"></span></div>';

      // Load LiveMonitor component dynamically (Simulated via Astro Island approach usually, but here we replace HTML)
      // In a real Astro app with client:load, we would pass the prop.
      // Since we are inside a script, we might redirect or fetch partial HTML.
      
      // For this blueprint, let's assume we redirect to a specific monitoring page or fetch data
      // A better approach in Astro is using a query param to re-render the server component
      window.location.href = `?session_id=${sessionId}`;
    });
  </script>

  {Astro.url.searchParams.get('session_id') && (
    <div slot="default">
      <!-- This overrides the content if session_id exists -->
       <div class="mb-4">
         <a href="/pengawas/monitoring/live" class="btn btn-sm btn-ghost mb-2">‚Üê Kembali Pilih Sesi</a>
         <LiveMonitor sessionId={parseInt(Astro.url.searchParams.get('session_id')!)} />
       </div>
    </div>
  )}
</DashboardLayout>