---
import MainLayout from '@/layouts/MainLayout.astro';

const attemptId = Astro.url.searchParams.get('attemptId');
if (!attemptId) return Astro.redirect('/siswa/dashboard');
---

<MainLayout title="Hasil Ujian">
  <div class="min-h-screen bg-base-200 flex items-center justify-center p-4">
    <div class="card w-full max-w-2xl bg-base-100 shadow-xl">
      <div class="card-body text-center">
        
        <!-- Icon Header -->
        <div class="mx-auto mb-4">
          <div class="w-24 h-24 rounded-full bg-success/20 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          </div>
        </div>

        <h2 class="card-title text-3xl justify-center mb-2">Ujian Selesai!</h2>
        <p class="text-base-content/70">Terima kasih telah mengerjakan ujian dengan jujur.</p>

        <div class="divider"></div>

        <!-- Result Content (Dynamic) -->
        <div id="result-container" class="py-4 space-y-4">
          <div class="loading loading-spinner loading-md"></div>
          <p>Memproses data jawaban...</p>
        </div>

        <!-- Sync Status (If Offline) -->
        <div id="sync-warning" class="hidden alert alert-warning text-left mt-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
          <div>
            <h3 class="font-bold">Menunggu Sinkronisasi</h3>
            <div class="text-xs">Jawaban tersimpan di perangkat. Mohon hubungkan ke internet agar nilai dapat diproses.</div>
          </div>
        </div>

        <div class="card-actions justify-center mt-8">
          <a href="/siswa/dashboard" class="btn btn-primary px-8">Kembali ke Dashboard</a>
        </div>
      </div>
    </div>
  </div>
</MainLayout>

<script define:vars={{ attemptId }}>
  import { db } from '@/lib/db/schema';
  import { syncManager } from '@/lib/offline/sync';
  
  const container = document.getElementById('result-container');
  const syncWarning = document.getElementById('sync-warning');

  async function checkResult() {
    // 1. Cek status sync di queue
    const queueItem = await db.sync_queue
      .where('attempt_id')
      .equals(parseInt(attemptId))
      .and(item => item.type === 'submission')
      .first();

    if (queueItem && queueItem.status !== 'completed') {
      // Masih pending / offline
      renderPending();
      
      // Coba trigger sync jika online
      if (navigator.onLine) {
        syncManager.processSyncQueue();
      }
    } else {
      // Sudah sync atau tidak ada di queue (berarti sudah di server)
      // Fetch hasil real dari API (Mocked here)
      renderScore(85, 100); // Contoh nilai
    }
  }

  function renderPending() {
    container.innerHTML = `
      <div class="stats shadow">
        <div class="stat">
          <div class="stat-title">Status</div>
          <div class="stat-value text-warning text-2xl">Tersimpan</div>
          <div class="stat-desc">Menunggu upload ke server</div>
        </div>
      </div>
    `;
    syncWarning.classList.remove('hidden');
  }

  function renderScore(score, max) {
    container.innerHTML = `
      <div class="stats shadow w-full max-w-md">
        <div class="stat place-items-center">
          <div class="stat-title">Nilai Akhir</div>
          <div class="stat-value text-primary text-4xl">${score}</div>
          <div class="stat-desc">Skala 0 - 100</div>
        </div>
        
        <div class="stat place-items-center">
          <div class="stat-title">Status</div>
          <div class="stat-value text-success text-2xl">Lulus</div>
          <div class="stat-desc">Di atas KKM</div>
        </div>
      </div>
    `;
    syncWarning.classList.add('hidden');
  }

  checkResult();
  
  // Listen for sync completion
  window.addEventListener('sync:progress', (e) => {
    if (e.detail.item.attempt_id === parseInt(attemptId) && e.detail.status === 'completed') {
      // Refresh result after sync
      setTimeout(() => renderScore(85, 100), 1000); 
    }
  });
</script>